;//////////////////////////////////////////////////////////////////////
;/// This file is subject to the terms and conditions defined in    ///
;/// file 'LICENSE.txt', which is part of this source code package. ///
;//////////////////////////////////////////////////////////////////////
[SEGMENT .text]
    ;////////////////////////////////////////////////////
    ;/// Define The entry point
    ;////////////////////////////////////////////////////
    GLOBAL _EngineEntry;

;////////////////////////////////////////////////////////
;/// ENGINE_COMMON_BEGIN
;////////////////////////////////////////////////////////
_Engine_Common_Begin:

    ;////////////////////////////////////////////////////
    ;/// Define all common includes
    ;////////////////////////////////////////////////////
    %INCLUDE 'src/EngineAPI.asm'
    %INCLUDE 'src/EngineDisassembler.asm'

;////////////////////////////////////////////////////////
;/// ENGINE_COMMON_END
;////////////////////////////////////////////////////////
_Engine_Common_End:

;////////////////////////////////////////////////////////
;/// FOUNDATION_BEGIN
;////////////////////////////////////////////////////////
_Foundation_Begin:

    ;////////////////////////////////////////////////////
    ;/// Define only server includes
    ;////////////////////////////////////////////////////
    %INCLUDE 'src/module/ModuleEntry.asm'

_Foundation_Entry:
    ;////////////////////////////////////////////////////
    ;/// Check if the debugger is present, to intercept it
    ;////////////////////////////////////////////////////
    CALL DWORD [IsDebuggerPresent]
    TEST EAX, EAX
    JZ   ._Foundation_Entry_Process

    ;////////////////////////////////////////////////////
    ;/// Signal the debugger
    ;////////////////////////////////////////////////////
    INT  0x03
    
._Foundation_Entry_Process:
    ;////////////////////////////////////////////////////
    ;/// Initialize Disassembler Enviroment
    ;////////////////////////////////////////////////////
    CALL InitializeDisassembler

    ;////////////////////////////////////////////////////
    ;/// Initialize Module Enviroment
    ;////////////////////////////////////////////////////
    CALL InitializeModule

    ;////////////////////////////////////////////////////
    ;/// Goodbye
    ;////////////////////////////////////////////////////
    RET
    
;////////////////////////////////////////////////////////
;/// FOUNDATION_END
;////////////////////////////////////////////////////////
_Foundation_End:

    ;////////////////////////////////////////////////////
    ;/// Define only client includes
    ;////////////////////////////////////////////////////
    %INCLUDE 'src/EngineInjector.asm'

;////////////////////////////////////////////////////////
;/// \brief Entry point of the application
;////////////////////////////////////////////////////////
_EngineEntry:
    ;////////////////////////////////////////////////////
    ;/// Initialize WinAPI Enviroment
    ;////////////////////////////////////////////////////
    CALL InitializeWinAPI

    ;////////////////////////////////////////////////////
    ;/// Initialize Disassembler Enviroment
    ;////////////////////////////////////////////////////
    CALL InitializeDisassembler

    ;////////////////////////////////////////////////////
    ;/// Parse the name of the client process name
    ;////////////////////////////////////////////////////
    %ifdef DEFAULT_NAME
        MOV EAX, __szFilename
    %else
        CALL ParseCommandLine
    %endif

    ;////////////////////////////////////////////////////
    ;/// Inject the code into the game
    ;////////////////////////////////////////////////////
    PUSH (_Foundation_End - _Engine_Common_Begin)
    PUSH (_Engine_Common_Begin)
    PUSH (_Foundation_Entry - _Engine_Common_Begin)
    PUSH EAX
    CALL ExecuteCodeOnApplication

    ;////////////////////////////////////////////////////
    ;/// Goodbye
    ;////////////////////////////////////////////////////
    PUSH 0x00000001
    CALL DWORD [ExitProcess]
